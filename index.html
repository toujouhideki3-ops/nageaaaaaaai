<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥ å¤ªé¼“ã®é”äºº ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒƒãƒ ğŸ†</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>

    <script id="firebase-config">
        const firebaseConfig ={
  apiKey: "AIzaSyBK36L7UpWxDW6SUYiRU1xVvnbFn5OOxzI",
  authDomain: "nageai.firebaseapp.com",
  projectId: "nageai",
  storageBucket: "nageai.firebasestorage.app",
  messagingSenderId: "858906804092",
  appId: "1:858906804092:web:202e2bff5e36f68f286ef9",
  measurementId: "G-C2C9SB3MMP"
};

        // Firebaseã®åˆæœŸåŒ–
        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const db = app.firestore();
    </script>
    
    <style>
        :root {
            --primary-color: #ff3333; /* ãŠç¥­ã‚Šãƒ¬ãƒƒãƒ‰ */
            --primary-dark: #cc0000;
            --accent-color: #ffcc00;
            --bg-gradient: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-color: #4a4a4a;
            --shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-color);
            text-align: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(#fff 15%, transparent 16%), radial-gradient(#fff 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            opacity: 0.1;
            z-index: -1;
            animation: bgScroll 20s linear infinite;
        }

        @keyframes bgScroll {
            from { background-position: 0 0, 10px 10px; }
            to { background-position: 100px 100px, 110px 110px; }
        }

        .screen {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 550px;
            display: none;
            flex-direction: column;
            justify-content: center;
            border: 4px solid #fff;
            opacity: 0;
            transform: scale(0.9) translateY(20px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .screen.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        h1 {
            color: var(--primary-color);
            text-shadow: 2px 2px 0px #ffeebb;
            font-weight: 800;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        h2 {
            border-bottom: 3px dashed var(--primary-color);
            display: inline-block;
            padding-bottom: 5px;
            margin-bottom: 25px;
            color: #333;
        }
        
        .rating-display {
            font-size: 2em;
            font-weight: 800;
            color: #007bff;
            margin: 20px 0;
            background: #eef;
            padding: 15px;
            border-radius: 15px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-bottom: 6px solid var(--primary-dark);
            padding: 15px 30px;
            margin: 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            transition: all 0.1s;
            position: relative;
            top: 0;
        }
        
        #btnAuth, #btnRegister {
            background-color:#007bff !important; 
            border-bottom-color:#0056b3 !important;
        }
        
        #btnFraudDemo {
            background-color: #f89406; /* è­¦å‘Šè‰² */
            border-bottom-color: #cc7800;
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1.0em;
        }

        button:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        button:active {
            border-bottom-width: 2px;
            transform: translateY(4px);
        }
        
        .result-button {
            padding: 20px 30px;
            font-size: 1.3em;
            width: 100%;
            margin: 8px 0;
        }
        #btnWin { background-color: #28a745; border-bottom-color: #1e7e34; }
        #btnLoss { background-color: #dc3545; border-bottom-color: #bd2130; }
        #btnDraw { background-color: #ffc107; color: #444; border-bottom-color: #d39e00; }

        .music-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
            text-align: left;
        }

        .music-list li {
            background: #fff;
            border: 2px solid #eee;
            margin: 8px 0;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        
        .music-list li::before {
            content: "â™ª";
            color: var(--primary-color);
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .player-detail-table {
            width: 90%;
            margin: 15px auto;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        .player-detail-table th {
            background: #f8f9fa;
            color: var(--primary-color);
            width: 35%;
        }
        
        .result-heading-huge {
            font-size: 3em;
            font-weight: 900;
            margin: 10px 0;
            text-shadow: 3px 3px 0px rgba(0,0,0,0.1);
            animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes zoomIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .win-text { color: #28a745; text-shadow: 0 0 10px #7aff96; }
        .lose-text { color: #dc3545; }
        .draw-text { color: #ffc107; text-shadow: 2px 2px 0px #444; }

        .pulse-text {
            animation: pulse 1.5s infinite;
            color: #1DA1F2;
            font-weight: bold;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.6; }
        }

        .auth-input { padding:10px; margin:10px 0; width:80%; border-radius:8px; border: 1px solid #ccc;}
    </style>
</head>
<body>

    <div id="authScreen" class="screen">
        <h2>ğŸ‘¤ ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒƒãƒã¸ã‚ˆã†ã“ã</h2>
        
        <p style="font-size: 0.9em; margin-bottom: 25px; color: #555;">
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ã‚’è¡Œã„ã¾ã™ã€‚<br>
            **æ¨ã¦ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚„**èªè¨¼å°‚ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚‚åˆ©ç”¨å¯èƒ½ã§ã™ã€‚
        </p>
        
        <input type="text" id="email" class="auth-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="password" class="auth-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (6æ–‡å­—ä»¥ä¸Š)">
        <button id="btnRegister" onclick="handleAuth(true)">æ–°è¦ç™»éŒ²</button>
        <button id="btnAuth" onclick="handleAuth(false)">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="titleScreen" class="screen">
        <h1>ğŸ¥ å¤ªé¼“ã®é”äºº<br>ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒƒãƒ ğŸ†</h1>
        <div class="rating-display">
            RATING: <span id="playerRatingDisplay">1500</span>
        </div>
        <p>å®ŸåŠ›ãŒè¿‘ã„ç›¸æ‰‹ã¨ãƒãƒƒãƒãƒ³ã‚°ã—ã€<br>ãƒªã‚¶ãƒ«ãƒˆäº¤æ›ã§ãƒ¬ãƒ¼ãƒˆã‚’ç«¶ãŠã†ï¼</p>
        
        <div style="margin-top: 20px;">
            <button onclick="startMatch('online')">âš”ï¸ ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹ (å¯¾äºº)</button>
            <button onclick="startMatch('cpu')" style="background-color:#6c757d; border-bottom-color:#545b62;">ğŸ¤– CPUã¨ç·´ç¿’ (ãƒ†ã‚¹ãƒˆ)</button>
        </div>
        
        <button id="btnFraudDemo" onclick="startFraudDemo()" style="background:#f89406; border-bottom-color:#cc7800; margin-top: 20px; padding: 10px 20px; font-size: 1.0em;">ğŸš¨ ä¸æ­£æ¤œçŸ¥ãƒ‡ãƒ¢ (ä¸¡è€…å‹ã¡ç”»é¢ã‚’è¦‹ã‚‹)</button>
        <button onclick="logout()" style="background:#dc3545; border-bottom-color:#bd2130; margin-top: 10px; padding: 10px 20px; font-size: 1.0em;">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div id="matchResultScreen" class="screen">
        <h2 style="color: #28a745;">ğŸ‰ ãƒãƒƒãƒãƒ³ã‚°æˆç«‹ï¼</h2>
        
        <table class="player-detail-table">
            <tr>
                <th>ã‚ãªãŸ (Player)</th>
                <td id="myInfoDisplay"></td>
            </tr>
            <tr>
                <th>å¯¾æˆ¦ç›¸æ‰‹ (Rival)</th>
                <td id="opponentInfo"></td>
            </tr>
        </table>

        <h3>ğŸ“‚ ä»Šæ—¥ã®èª²é¡Œæ›² (3æ›²)</h3>
        <ul id="selectedSongs" class="music-list">
            </ul>
        <button onclick="goToResultSubmission()">ãƒªã‚¶ãƒ«ãƒˆäº¤æ›ãƒ»çµæœç”³å‘Šã¸ â¡</button>
    </div>

    <div id="resultSubmissionScreen" class="screen">
        <h2>ğŸ—³ï¸ å‹æ•—ã®ç”³å‘Š</h2>
        <p>ãƒªã‚¶ãƒ«ãƒˆç”»åƒã‚’äº¤æ›ã—ã€<br><strong>3æ›²åˆè¨ˆã®è‰¯ã®æ•°</strong>ã§å‹æ•—ã‚’æ±ºã‚ã¦ãã ã•ã„ã€‚</p>
        
        <div style="background:#f0f8ff; padding:10px; border-radius:10px; margin: 15px 0;">
            <span style="font-size:0.9em; color:#666;">å¯¾æˆ¦ç›¸æ‰‹</span><br>
            <span id="opponentDisplayInSubmission" style="font-size: 1.4em; font-weight: 800; color: #1DA1F2;"></span>
        </div>
        
        <h3 style="margin-top: 20px; font-size:1.1em;">ä»Šå›ã®èª²é¡Œæ›²</h3>
        <ul id="submissionSongs" class="music-list" style="font-size: 0.9em;">
             </ul>

        <div style="margin-top: 20px;">
            <p style="font-weight:bold; margin-bottom:10px;">ã‚ãªãŸã®çµæœã¯ï¼Ÿ</p>
            <div style="display:flex; gap:10px;">
                <button id="btnWin" class="result-button" onclick="submitResult(1)">ğŸ† å‹åˆ© (Win)</button>
                <button id="btnLoss" class="result-button" onclick="submitResult(0)">ğŸ’€ æ•—åŒ— (Lose)</button>
            </div>
            <button id="btnDraw" class="result-button" style="margin-top:0;" onclick="submitResult(0.5)">ğŸ¤ å¼•ãåˆ†ã‘ (Draw)</button>
        </div>
    </div>
    
    <div id="waitingScreen" class="screen" style="text-align: center;">
        <h2 id="waitingScreenTitle">â³ ç›¸æ‰‹ã‚’æ¢ã—ã¦ã„ã¾ã™...</h2>
        <div style="margin: 40px 0;">
            <p class="pulse-text" style="font-size: 3em;">ğŸ¥</p>
            <p style="font-size: 1.2em;" id="waitingScreenText">ãƒãƒƒãƒãƒ³ã‚°ã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²ã—ã¾ã—ãŸã€‚<br>å®ŸåŠ›ãŒè¿‘ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ¤œç´¢ä¸­ã§ã™ã€‚</p>
        </div>
        
        <div style="margin-top: 30px;">
            <button onclick="resetGame()" style="background:#999; border-bottom-color:#777; font-size:0.9em;">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹ (å¼·åˆ¶ä¸­æ–­)</button>
        </div>
    </div>

    <div id="resultScreen" class="screen">
        <div id="resultHeading" class="result-heading-huge"></div>
        <p>ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—å®Œäº†ï¼</p>
        
        <table class="rating-table">
            <thead>
                <tr>
                    <th>PLAYER</th>
                    <th>æ—§ãƒ¬ãƒ¼ãƒˆ</th>
                    <th>æ¨ç§»</th>
                    <th>æ–°ãƒ¬ãƒ¼ãƒˆ</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="font-weight:bold;">ã‚ãªãŸ</td>
                    <td id="playerOldR"></td>
                    <td>â¡</td>
                    <td style="font-size:1.4em; font-weight:800;" id="playerNewR"></td>
                </tr>
                <tr>
                    <td>RIVAL</td>
                    <td id="cpuOldR"></td>
                    <td>â¡</td>
                    <td id="cpuNewR"></td>
                </tr>
            </tbody>
        </table>
        
        <div style="margin: 20px 0; font-size: 2em; font-weight: 800;">
            <span id="diffDisplay"></span>
        </div>

        <button onclick="resetGame()">ğŸ  ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>


    <script>
        // --- è¨­å®šå€¤ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿ ---
        const SONG_POOL = [
            "Infinite Rebellion", "å½ï¼ˆè£ï¼‰", "CRUXNAUT", "The Future of the å¤ªé¼“ãƒ‰ãƒ©ãƒ ï¼ˆè£ï¼‰", 
            "ç¥ç«œ ï½Shinryuï½ï¼ˆè£ï¼‰", "æ†æ‚ªã¨é†œæ‚ªã®èŠ±æŸï¼ˆè£ï¼‰", "ãƒ€ãƒ¼ã‚¯ãƒ»ã‚¨ã‚¯ã‚¹ãƒ»ãƒã‚­ãƒŠâ™¡", 
            "ç¬¬å…­å¤©é­”ç‹ï¼ˆè¡¨ï¼‰", "ç¬¬å…­å¤©é­”ç‹ï¼ˆè£ï¼‰", "ãƒ€ãƒ³ã‚¬ãƒ³ãƒãƒ¼ãƒ„ï¼ˆè£ï¼‰", "Destination 2F29", 
            "ãƒ‰ãƒ³ã‚«ãƒ2000", "23æ™‚54åˆ†ã€é™½ã®æ—…è·¯ã¸ã®ãƒ—ãƒ¬ãƒªãƒ¥ãƒ¼ãƒ‰ï¼ˆè£ï¼‰", "Vixtoryï¼ˆè£ï¼‰", 
            "vs.VIGVANGSï¼ˆè£ï¼‰", "poxeiâ™¦DOON", "å¹½ç„ãƒä¹±"
        ];
        const K_FACTOR = 32;
        const INITIAL_RATING = 1500;
        const SIMULATION_DELAY_MS = 4000; 

        // --- ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆ (Firebaseç”¨å¤‰æ•°ã«æ›´æ–°) ---
        let CURRENT_USER_ID = null;
        let CURRENT_USER_RATING = INITIAL_RATING;
        let CURRENT_TAIKO_ID = "ã‚²ã‚¹ãƒˆ";
        
        let opponentXId = null;
        let opponentUid = null;
        let opponentRating = INITIAL_RATING; 
        
        let playerReportedResult = null;
        let opponentReportedResult = null;
        let isFraudDemoMode = false;
        
        let matchQueueListener = null;

        // --- èªè¨¼ãƒ»ãƒ‡ãƒ¼ã‚¿æ“ä½œ ---

        function handleAuth(isRegister) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (email.length < 5 || password.length < 6) {
                alert("å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ (ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Š)ã€‚");
                return;
            }

            if (isRegister) {
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        initializeUserProfile(userCredential.user.uid, email);
                    })
                    .catch((error) => {
                        alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + error.message);
                    });
            } else {
                auth.signInWithEmailAndPassword(email, password)
                    .catch((error) => {
                        alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + error.message);
                    });
            }
        }
        
        function logout() {
             auth.signOut().then(() => {
                 alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");
             });
        }
        
        function initializeUserProfile(uid, email) {
            const taikoId = 'Player_' + Math.random().toString(36).substring(2, 6).toUpperCase();
            db.collection('users').doc(uid).set({
                uid: uid,
                email: email,
                rating: INITIAL_RATING,
                taikoId: taikoId,
            }).then(() => {
                loadUserProfile(uid);
            });
        }
        
        function loadUserProfile(uid) {
            db.collection('users').doc(uid).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    CURRENT_USER_RATING = data.rating;
                    CURRENT_TAIKO_ID = data.taikoId;
                    
                    document.getElementById('playerRatingDisplay').textContent = Math.round(CURRENT_USER_RATING);
                    showScreen('titleScreen');
                }
            });
        }
        
        function saveNewRating(newRating) {
            db.collection('users').doc(CURRENT_USER_ID).update({
                rating: newRating
            }).then(() => {
                console.log("ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
            });
        }

        // --- èªè¨¼çŠ¶æ…‹ã®ç›£è¦– ---
        auth.onAuthStateChanged(user => {
            if (user) {
                CURRENT_USER_ID = user.uid;
                loadUserProfile(user.uid);
            } else {
                showScreen('authScreen');
            }
        });

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
        function showScreen(screenId) { 
            document.querySelectorAll('.screen').forEach(el => {
                el.classList.remove('visible');
                setTimeout(() => {
                    if(!el.classList.contains('visible')) el.style.display = 'none';
                }, 400);
            });

            setTimeout(() => {
                const targetScreen = document.getElementById(screenId);
                targetScreen.style.display = 'flex';
                void targetScreen.offsetWidth;
                targetScreen.classList.add('visible'); 
            }, 200);
        }

        function generateRandomXId(isCPU) {
             if (isCPU) {
                 const cpuNames = ["DON-Chan", "KATSU-Kun", "TaikoMaster", "DrumKing"];
                 const suffix = Math.floor(Math.random() * 900) + 100;
                 return `@${cpuNames[Math.floor(Math.random() * cpuNames.length)]}_${suffix}`;
             }
             return "@Rival_" + Math.random().toString(36).substring(2, 6).toUpperCase();
        }
        
        // ğŸš¨ ä¿®æ­£ç®‡æ‰€ 1: å¾…æ©Ÿç”»é¢ã®è¡¨ç¤ºå†…å®¹ã‚’å‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function showWaitingScreen(type, rivalName = null) {
            const titleEl = document.getElementById('waitingScreenTitle');
            const textEl = document.getElementById('waitingScreenText');
            
            if (type === 'match') {
                titleEl.textContent = 'â³ ç›¸æ‰‹ã‚’æ¢ã—ã¦ã„ã¾ã™...';
                textEl.innerHTML = 'ãƒãƒƒãƒãƒ³ã‚°ã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²ã—ã¾ã—ãŸã€‚<br>å®ŸåŠ›ãŒè¿‘ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ¤œç´¢ä¸­ã§ã™ã€‚';
            } else if (type === 'submission') {
                titleEl.textContent = 'â³ ç›¸æ‰‹ã®ç”³å‘Šå¾…ã¡...';
                textEl.innerHTML = `ç›¸æ‰‹ï¼ˆ<span style="color: #1DA1F2; font-weight:bold;">${rivalName || 'ç›¸æ‰‹'}</span>ï¼‰ãŒ<br>çµæœã‚’å…¥åŠ›ã—ã¦ã„ã¾ã™ã€‚`;
            }

            showScreen('waitingScreen');
        }

        function resetGame() {
            if (matchQueueListener) {
                 matchQueueListener();
                 matchQueueListener = null;
                 db.collection('matchQueue').doc(CURRENT_USER_ID).delete(); 
            }

            playerReportedResult = null;
            opponentReportedResult = null;
            isFraudDemoMode = false;
            
            document.getElementById('playerRatingDisplay').textContent = Math.round(CURRENT_USER_RATING);
            showScreen('titleScreen');
        }

        function selectRandomSongs(count) {
            const shuffled = [...SONG_POOL].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // --- Eloè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
        function calculateExpectedScore(Ra, Rb) { return 1.0 / (1.0 + Math.pow(10, (Rb - Ra) / 400)); }
        function updateRating(R, E, S, K) { return R + K * (S - E); }

        // --- ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼ (Firebaseçµ±åˆ) ---
        
        function startMatch(mode) {
            isFraudDemoMode = false;

            if (mode === 'cpu') {
                 // CPUæˆ¦ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¾ã¾
                 opponentUid = 'CPU';
                 opponentRating = CURRENT_USER_RATING + Math.floor(Math.random() * 300) - 150;
                 opponentXId = generateRandomXId(true);
                 handleMatchFound();
                 return;
            }

            // --- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒƒãƒãƒ³ã‚° ---
            alert("ãƒãƒƒãƒãƒ³ã‚°ã‚­ãƒ¥ãƒ¼ã«å‚åŠ ã—ã¾ã™ã€‚");
            
            const matchData = {
                uid: CURRENT_USER_ID,
                taikoId: CURRENT_TAIKO_ID,
                rating: CURRENT_USER_RATING,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'waiting',
            };

            db.collection('matchQueue').doc(CURRENT_USER_ID).set(matchData)
                .then(() => {
                    listenForOpponent(CURRENT_USER_RATING);
                    // ğŸš¨ ä¿®æ­£ç®‡æ‰€ 2: ãƒãƒƒãƒãƒ³ã‚°å¾…æ©Ÿç”»é¢ã¸é·ç§»
                    showWaitingScreen('match'); 
                })
                .catch(error => {
                    alert("ãƒãƒƒãƒãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: " + error.message);
                });
        }
        
        function startFraudDemo() {
            isFraudDemoMode = true;
            opponentUid = 'DEMO_CPU';
            opponentRating = CURRENT_USER_RATING + Math.floor(Math.random() * 300) - 150;
            opponentXId = "@FraudDemo_Rival";

            alert("ğŸš¨ ä¸æ­£æ¤œçŸ¥ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™ã€‚\n\næ¬¡ã®ç”»é¢ã§ã€å‹åˆ© (Win)ã€ã‚’é¸ã³ã€ã‚·ã‚¹ãƒ†ãƒ ãŒä¸¡è€…å‹ã¡ã‚’æ¤œçŸ¥ã™ã‚‹æ§˜å­ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            handleMatchFound();
        }

        function listenForOpponent(playerR) {
            if (matchQueueListener) matchQueueListener(); 

            const R_RANGE = 150; 

            const query = db.collection('matchQueue')
                .where('status', '==', 'waiting')
                .orderBy('rating', 'desc') 
                .limit(5);

            matchQueueListener = query.onSnapshot(async snapshot => {
                let bestMatch = null;
                let minDiff = Infinity;

                snapshot.forEach(doc => {
                    const opponent = doc.data();
                    
                    if (opponent.uid !== CURRENT_USER_ID) { 
                        const diff = Math.abs(opponent.rating - playerR);
                        if (diff <= R_RANGE && diff < minDiff) {
                            minDiff = diff;
                            bestMatch = opponent;
                        }
                    }
                });
                
                if (bestMatch) {
                    matchQueueListener(); 
                    
                    try {
                        const result = await db.runTransaction(async transaction => {
                            const playerRef = db.collection('matchQueue').doc(CURRENT_USER_ID);
                            const opponentRef = db.collection('matchQueue').doc(bestMatch.uid);
                            
                            const playerDoc = await transaction.get(playerRef);
                            const opponentDoc = await transaction.get(opponentRef);

                            if (playerDoc.data().status === 'waiting' && opponentDoc.data().status === 'waiting') {
                                
                                const matchId = CURRENT_USER_ID.substring(0, 4) + bestMatch.uid.substring(0, 4) + Date.now();
                                
                                transaction.update(playerRef, { status: 'matched', opponentUid: bestMatch.uid, matchId: matchId, opponentTaikoId: bestMatch.taikoId });
                                transaction.update(opponentRef, { status: 'matched', opponentUid: CURRENT_USER_ID, matchId: matchId, opponentTaikoId: CURRENT_TAIKO_ID });
                                
                                return {opponent: bestMatch, matchId: matchId};
                            }
                            throw new Error("ç›¸æ‰‹ãŒæ—¢ã«ãƒãƒƒãƒãƒ³ã‚°ã‚’æˆç«‹ã•ã›ã¾ã—ãŸã€‚");
                        });
                        
                        handleMatchFound(result.opponent);

                    } catch (error) {
                        console.error("ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤±æ•—:", error);
                        alert("ãƒãƒƒãƒãƒ³ã‚°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
                        resetGame();
                    }
                }
            });
        }
        
        function handleMatchFound(opponentData) {
            if (opponentData) {
                 opponentUid = opponentData.uid;
                 opponentRating = opponentData.rating;
                 opponentXId = opponentData.taikoId;
            }
            
            document.getElementById('myInfoDisplay').innerHTML =Â 
                 `<span style="color:#007bff; font-weight:bold;">${CURRENT_TAIKO_ID}</span><br>Rating: ${Math.round(CURRENT_USER_RATING)}`;
            document.getElementById('opponentInfo').innerHTML =Â 
                 `<span style="color:#e44d26; font-weight:bold;">${opponentXId}</span><br>Rating: ${Math.round(opponentRating)}`;

            let selectedSongs = selectRandomSongs(3);
            const songListElement = document.getElementById('selectedSongs');
            const submissionSongsElement = document.getElementById('submissionSongs');
            songListElement.innerHTML = '';
            submissionSongsElement.innerHTML = '';
            selectedSongs.forEach((song, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span style="color:#999; margin-right:5px;">#${index+1}</span> ${song}`;
                li.style.animation = `fadeIn 0.5s ease forwards ${index * 0.1}s`;
                li.style.opacity = '0';
                songListElement.appendChild(li.cloneNode(true));
                submissionSongsElement.appendChild(li); // çµæœç”³å‘Šç”»é¢ã«ã‚‚åæ˜ 
            });

            showScreen('matchResultScreen');
        }

        // --- ç”³å‘Šãƒ»çµæœå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ (è¿½åŠ ) ---

        function goToResultSubmission() {
             document.getElementById('opponentDisplayInSubmission').textContent = opponentXId;
             showScreen('resultSubmissionScreen');
        }

        function submitResult(pResult) {
            playerReportedResult = pResult;
            
            if (opponentUid === 'CPU' || isFraudDemoMode) {
                // CPUæˆ¦ã¾ãŸã¯ãƒ‡ãƒ¢ã®å ´åˆã¯å³åº§ã«ç›¸æ‰‹ã®çµæœã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                simulateCpuSubmission(pResult);
            } else {
                // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ã®å ´åˆ: è‡ªåˆ†ã®çµæœã‚’DBã«æ›¸ãè¾¼ã¿ã€ç›¸æ‰‹ã®ç”³å‘Šã‚’å¾…ã¤
                // (æ³¨æ„: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ãƒ­ã‚¸ãƒƒã‚¯ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€ãƒ•ãƒ­ãƒ¼ã¯å®Œæˆã•ã›ã¾ã™)
                
                // ğŸš¨ ä¿®æ­£ç®‡æ‰€ 3: ç”³å‘Šå¾…ã¡ç”»é¢ã¸é·ç§»
                showWaitingScreen('submission', opponentXId);
                
                // å®Ÿéš›ã«ã¯ã“ã“ã§ DB ã«çµæœã‚’æ›¸ãè¾¼ã¿ã€ç›¸æ‰‹ã®çµæœã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
                // ä»Šå›ã¯ãƒ‡ãƒ¢ã®ãŸã‚ã€ç›¸æ‰‹ã®ç”³å‘Šã¯ã€Œæ‰‹å‹•ã§åˆ¥ç«¯æœ«ã‹ã‚‰è¡Œã†ã€ã‹ã€Œæ™‚é–“çµŒéã§ã‚¨ãƒ©ãƒ¼ã€ã‚’æƒ³å®šã—ã¾ã™ã€‚
                
                // 3ç§’å¾Œã«å¼·åˆ¶çš„ã«çµæœãƒã‚§ãƒƒã‚¯ (ç›¸æ‰‹ãŒç”³å‘Šæ¸ˆã¿ã¨ä»®å®š)
                setTimeout(() => {
                     // ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                     if (isFraudDemoMode) {
                          // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ç›¸æ‰‹ã‚‚å‹ã¡(1)ã‚’ç”³å‘Šã—ãŸã¨ä»®å®š
                          opponentReportedResult = 1; 
                          checkResultsAndCalculate();
                     } else {
                          // ç›¸æ‰‹ãŒæœªç”³å‘Šã®å ´åˆã¯æ™‚é–“åˆ‡ã‚Œ/ã‚¿ã‚¤ãƒˆãƒ«ã¸
                          // alert('ç›¸æ‰‹ã®ç”³å‘ŠãŒç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚Šã¾ã™ã€‚');
                          // resetGame();
                          // ä¸€æ—¦ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ã‚‚ç°¡æ˜“å‡¦ç†ã‚’è¡Œã† (ãƒ‡ãƒ¢ç”¨)
                          opponentReportedResult = (pResult === 1) ? 0 : (pResult === 0) ? 1 : 0.5;
                          checkResultsAndCalculate();
                     }
                }, 3000); 
            }
        }

        function simulateCpuSubmission(playerResult) {
            // CPUã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨é€†ã®çµæœã‚’ç”³å‘Šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ (å¼•ãåˆ†ã‘ã¯åŠã€…)
            if (isFraudDemoMode) {
                 opponentReportedResult = 1; // ãƒ‡ãƒ¢: ç›¸æ‰‹ã‚‚ã€Œå‹ã¡ã€ã‚’ç”³å‘Š
            } else {
                 opponentReportedResult = (playerResult === 1) ? 0 : (playerResult === 0) ? 1 : 0.5;
            }
            checkResultsAndCalculate();
        }

        function checkResultsAndCalculate() {
            let finalResult = playerReportedResult;
            let resultText = '';
            let resultClass = '';
            
            // ä¸æ­£æ¤œçŸ¥ (ä¸¡è€…å‹ã¡/ä¸¡è€…è² ã‘)
            if (playerReportedResult === 1 && opponentReportedResult === 1) {
                resultText = "âš ï¸ ä¸æ­£æ¤œçŸ¥ (ä¸¡è€…å‹ã¡)";
                resultClass = "draw-text";
                finalResult = 0.5; // ãƒ¬ãƒ¼ãƒˆå¤‰å‹•ã¯å¼•ãåˆ†ã‘ã¨ã—ã¦å‡¦ç†
                alert("ğŸš¨ ä¸¡è€…ã‹ã‚‰å‹åˆ©ã®ç”³å‘ŠãŒã‚ã‚Šã¾ã—ãŸã€‚ä¸æ­£è¡Œç‚ºã‚’æ¤œçŸ¥ã—ãŸãŸã‚ã€çµæœã¯ã€å¼•ãåˆ†ã‘ã€ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚");
            } else if (playerReportedResult === 0 && opponentReportedResult === 0) {
                 resultText = "âš ï¸ ä¸æ­£æ¤œçŸ¥ (ä¸¡è€…è² ã‘)";
                 resultClass = "draw-text";
                 finalResult = 0.5; // ãƒ¬ãƒ¼ãƒˆå¤‰å‹•ã¯å¼•ãåˆ†ã‘ã¨ã—ã¦å‡¦ç†
                 alert("ğŸš¨ ä¸¡è€…ã‹ã‚‰æ•—åŒ—ã®ç”³å‘ŠãŒã‚ã‚Šã¾ã—ãŸã€‚ä¸æ­£è¡Œç‚ºã‚’æ¤œçŸ¥ã—ãŸãŸã‚ã€çµæœã¯ã€å¼•ãåˆ†ã‘ã€ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚");
            } else if (playerReportedResult === opponentReportedResult) {
                resultText = "ğŸ¤ å¼•ãåˆ†ã‘";
                resultClass = "draw-text";
            } else if (playerReportedResult === 1) {
                resultText = "ğŸ† å‹åˆ©ï¼";
                resultClass = "win-text";
            } else { // pResult === 0
                resultText = "ğŸ’€ æ•—åŒ—";
                resultClass = "lose-text";
            }

            calculateAndDisplayRating(finalResult, resultText, resultClass);
        }
        
        function calculateAndDisplayRating(pResult, rText, rClass) {
            
            // 1. Eloè¨ˆç®—
            const expectedPlayerScore = calculateExpectedScore(CURRENT_USER_RATING, opponentRating);
            const oldPlayerR = CURRENT_USER_RATING;
            const newPlayerR = updateRating(oldPlayerR, expectedPlayerScore, pResult, K_FACTOR);
            
            // 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°
            saveNewRating(newPlayerR); 
            CURRENT_USER_RATING = newPlayerR; 

            // 3. ç”»é¢è¡¨ç¤ºæ›´æ–°ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const oldCpuR = opponentRating;
            const newCpuR = updateRating(oldCpuR, 1 - expectedPlayerScore, 1 - pResult, K_FACTOR);
            const deltaPlayerR = Math.round(newPlayerR - oldPlayerR);
            
            const resultHeading = document.getElementById('resultHeading');
            resultHeading.textContent = rText;
            resultHeading.className = "result-heading-huge " + rClass;

            document.getElementById('playerOldR').textContent = Math.round(oldPlayerR);
            document.getElementById('playerNewR').textContent = Math.round(oldPlayerR); 
            document.getElementById('cpuOldR').textContent = Math.round(oldCpuR);
            document.getElementById('cpuNewR').textContent = Math.round(oldCpuR);
            
            showScreen('resultScreen');

            setTimeout(() => {
                animateValue("playerNewR", Math.round(oldPlayerR), Math.round(newPlayerR), 1500);
                animateValue("cpuNewR", Math.round(oldCpuR), Math.round(newCpuR), 1500);
                
                const diffEl = document.getElementById('diffDisplay');
                 if(deltaPlayerR > 0) { diffEl.textContent = `+${deltaPlayerR}`; diffEl.style.color = 'blue'; } 
                 else if (deltaPlayerR < 0) { diffEl.textContent = `${deltaPlayerR}`; diffEl.style.color = 'red'; }
                 else { diffEl.textContent = `Â±0`; diffEl.style.color = '#777'; }
            }, 500); 
        }

        function animateValue(id, start, end, duration) {
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / Math.abs(range)));
            const obj = document.getElementById(id);

            const timer = setInterval(() => {
                current += increment;
                obj.textContent = Math.round(current);
                if (current === end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }


        // åˆæœŸåŒ–
        document.addEventListener("DOMContentLoaded", () => {
             // èªè¨¼ãƒªã‚¹ãƒŠãƒ¼ãŒåˆæœŸç”»é¢ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã€åˆå›ã®ã¿authScreenã‚’è¡¨ç¤º
             document.getElementById('authScreen').style.display = 'flex';
             setTimeout(()=>document.getElementById('authScreen').classList.add('visible'), 100);
        });
    </script>
</body>
</html>
