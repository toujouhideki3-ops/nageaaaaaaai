<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥ å¤ªé¼“ã®é”äºº ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒƒãƒ (çµæœç”³å‘Š) ğŸ†</title>
    <style>
        /* --- CSS ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            text-align: center;
            padding: 20px;
        }

        .screen {
            background: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
            min-height: 400px;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
            flex-direction: column;
            justify-content: center;
            
            /* --- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨è¨­å®š --- */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºçŠ¶æ…‹ */
        .screen.visible {
            opacity: 1;
            transform: translateY(0);
        }

        h1 { color: #e44d26; } /* å¤ªé¼“ã®èµ¤ */
        h2 { color: #333; }
        
        .rating-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff; /* é’ */
            margin-bottom: 20px;
        }

        /* çµæœè¡¨ç¤ºã®è‰² */
        .win-text { color: #007bff; }
        .lose-text { color: #dc3545; }
        .draw-text { color: #ffc107; }

        button {
            background-color: #e44d26;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #d43b1a;
        }
        
        /* ç”³å‘Šãƒœã‚¿ãƒ³ã®ç‰¹æ®Šãªã‚¹ã‚¿ã‚¤ãƒ« */
        .result-button {
            padding: 20px 40px;
            font-size: 1.5em;
        }
        #btnWin { background-color: #28a745; } /* ç·‘ */
        #btnLoss { background-color: #dc3545; } /* èµ¤ */
        #btnDraw { background-color: #ffc107; color: #333; } /* é»„ */

        .music-list {
            list-style: none;
            padding: 0;
            font-size: 1.1em;
            margin: 20px 0;
            text-align: left;
            width: 80%;
            margin: 20px auto;
        }

        .music-list li {
            background: #eee;
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
        }
        
        .rating-table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        
        .rating-table th, .rating-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
            font-size: 1.1em;
        }
        
        .rating-table th {
            background-color: #e44d26;
            color: white;
        }
        
        .opponent-info {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }
        
        /* ãƒ¬ãƒ¼ãƒˆå¤‰å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        .delta-rate-change {
            font-weight: bold;
            transition: all 0.5s ease;
            display: inline-block;
        }
        
        .player-detail-table {
            width: 90%;
            margin: 15px auto;
            border-collapse: collapse;
            font-size: 1.2em;
        }
        .player-detail-table th, .player-detail-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px dashed #ccc;
        }
        .player-detail-table th {
            width: 30%;
            color: #e44d26;
        }
    </style>
</head>
<body>

    <div id="titleScreen" class="screen">
        <h1>ğŸ¥ å¤ªé¼“ã®é”äºº ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒƒãƒ ğŸ†</h1>
        <div class="rating-display">
            ã‚ãªãŸã®ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°: <span id="playerRatingDisplay">1500</span>
        </div>
        <p>å¯¾æˆ¦ç›¸æ‰‹ã¨ã®ãƒªã‚¶ãƒ«ãƒˆäº¤æ›ã«åŸºã¥ãã€å‹æ•—ã‚’ç”³å‘Šã—ã¦ãã ã•ã„ã€‚</p>
        
        <button onclick="startMatch('online')">ãƒãƒƒãƒãƒ³ã‚°ã«å‚åŠ  (å¯¾äººã‚·ãƒŸãƒ¥)</button>
        <button onclick="startMatch('cpu')">CPUã¨ãƒãƒƒãƒãƒ³ã‚° (ãƒ†ã‚¹ãƒˆç”¨)</button>
    </div>

    <div id="matchResultScreen" class="screen">
        <h2>ğŸ‰ ãƒãƒƒãƒãƒ³ã‚°æˆç«‹ï¼</h2>
        
        <table class="player-detail-table">
            <tr>
                <th>ã‚ãªãŸ (Player)</th>
                <td id="myInfoDisplay"></td>
            </tr>
            <tr>
                <th>å¯¾æˆ¦ç›¸æ‰‹ (Rival)</th>
                <td id="opponentInfo"></td>
            </tr>
        </table>

        <h3>ä»Šæ—¥ã®èª²é¡Œæ›² (3æ›²)</h3>
        <ul id="selectedSongs" class="music-list">
            </ul>
        <button onclick="goToResultSubmission()">ãƒªã‚¶ãƒ«ãƒˆäº¤æ›ãƒ»çµæœç”³å‘Šã¸</button>
    </div>

    <div id="resultSubmissionScreen" class="screen">
        <h2>ğŸ—³ï¸ è©¦åˆçµæœã®ç”³å‘Š ğŸ—³ï¸</h2>
        <p>å¯¾æˆ¦ç›¸æ‰‹ã¨X (DM) ã§ãƒªã‚¶ãƒ«ãƒˆç”»åƒã‚’äº¤æ›ã—ã€**3æ›²åˆè¨ˆã®è‰¯ã®æ•°**ã§å‹æ•—ã‚’ç¢ºå®šã—ãŸå¾Œã€çµæœã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
        
        <h3 style="color: #007bff; margin-top: 25px;">ç¢ºèª: ä»Šå›ã®èª²é¡Œæ›²</h3>
        <ul id="submissionSongs" class="music-list">
             </ul>

        <div style="margin-top: 30px;">
            <button id="btnWin" class="result-button" onclick="submitResult(1)">å‹åˆ© (Win)</button>
            <button id="btnLoss" class="result-button" onclick="submitResult(0)">æ•—åŒ— (Lose)</button> <button id="btnDraw" class="result-button" onclick="submitResult(0.5)">å¼•ãåˆ†ã‘ (Draw)</button>
        </div>
    </div>
    
    <div id="resultScreen" class="screen">
        <h2 id="resultHeading"></h2>
        <p>å¯¾æˆ¦çµæœãŒç”³å‘Šã•ã‚Œã¾ã—ãŸã€‚ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå¤‰å‹•ã—ã¾ã™ã€‚</p>
        
        <table class="rating-table">
            <thead>
                <tr>
                    <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
                    <th>æ—§R</th>
                    <th>æ–°R</th>
                    <th>å¢—æ¸›</th>
                    <th>äºˆæƒ³å‹ç‡</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>ã‚ãªãŸ</td>
                    <td id="playerOldR"></td>
                    <td id="playerNewR"></td>
                    <td class="delta-rate-change" id="playerDeltaR"></td>
                    <td id="playerExpected"></td>
                </tr>
                <tr>
                    <td>å¯¾æˆ¦ç›¸æ‰‹</td>
                    <td id="cpuOldR"></td>
                    <td id="cpuNewR"></td>
                    <td class="delta-rate-change" id="cpuDeltaR"></td>
                    <td id="cpuExpected"></td>
                </tr>
            </tbody>
        </table>

        <button onclick="resetGame()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>


    <script>
        // --- è¨­å®šå€¤ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿ ---
        const SONG_POOL = [
            "Infinite Rebellion", "å½ï¼ˆè£ï¼‰", "CRUXNAUT", "The Future of the å¤ªé¼“ãƒ‰ãƒ©ãƒ ï¼ˆè£ï¼‰", 
            "ç¥ç«œ ï½Shinryuï½ï¼ˆè£ï¼‰", "æ†æ‚ªã¨é†œæ‚ªã®èŠ±æŸï¼ˆè£ï¼‰", "ãƒ€ãƒ¼ã‚¯ãƒ»ã‚¨ã‚¯ã‚¹ãƒ»ãƒã‚­ãƒŠâ™¡", 
            "ç¬¬å…­å¤©é­”ç‹ï¼ˆè¡¨ï¼‰", "ç¬¬å…­å¤©é­”ç‹ï¼ˆè£ï¼‰", "ãƒ€ãƒ³ã‚¬ãƒ³ãƒãƒ¼ãƒ„ï¼ˆè£ï¼‰", "Destination 2F29", 
            "ãƒ‰ãƒ³ã‚«ãƒ2000", "23æ™‚54åˆ†ã€é™½ã®æ—…è·¯ã¸ã®ãƒ—ãƒ¬ãƒªãƒ¥ãƒ¼ãƒ‰ï¼ˆè£ï¼‰", "Vixtoryï¼ˆè£ï¼‰", 
            "vs.VIGVANGSï¼ˆè£ï¼‰", "poxeiâ™¦DOON", "å¹½ç„ãƒä¹±"
        ];
        const K_FACTOR = 32;
        const INITIAL_RATING = 1500;

        // --- ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆ ---
        let playerRating = INITIAL_RATING;
        let cpuRating = INITIAL_RATING;
        let opponentXId = '';
        const PLAYER_ID = "@TaikoLover_Rater"; // ä¾¿å®œä¸Šã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ID

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

        // ç”»é¢è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ã)
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => {
                el.classList.remove('visible');
                el.style.display = 'none'; 
            });
            const targetScreen = document.getElementById(screenId);
            targetScreen.style.display = 'flex'; // è¡¨ç¤ºã‚’æœ‰åŠ¹åŒ–
            
            // çŸ­ã„ãƒ‡ã‚£ãƒ¬ã‚¤ã‚’ã‹ã‘ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
            setTimeout(() => {
                targetScreen.classList.add('visible'); 
            }, 10); 
        }

        // ç°¡æ˜“çš„ãªãƒ©ãƒ³ãƒ€ãƒ IDç”Ÿæˆé–¢æ•°
        function generateRandomXId(isCPU) {
            if (isCPU) {
                const cpuNames = ["TaikoRival", "R_Mash", "Donbot", "KatsuKing"];
                const suffix = Math.floor(Math.random() * 900) + 100;
                return `@${cpuNames[Math.floor(Math.random() * cpuNames.length)]}_${suffix}`;
            }
            return "@AnonPlayer_" + Math.random().toString(36).substring(2, 8);
        }

        // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®è¡¨ç¤ºã¨ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®æ›´æ–°
        function resetGame() {
            document.getElementById('playerRatingDisplay').textContent = Math.round(playerRating);
            showScreen('titleScreen');
        }

        // 3æ›²ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æ›²ã™ã‚‹
        function selectRandomSongs(count) {
            const shuffled = [...SONG_POOL].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // --- Eloãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        function calculateExpectedScore(Ra, Rb) {
            return 1.0 / (1.0 + Math.pow(10, (Rb - Ra) / 400));
        }

        function updateRating(R, E, S, K) {
            return R + K * (S - E);
        }

        // --- ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼é–¢æ•° ---

        // ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹å‡¦ç†
        function startMatch(mode) {
            // å¯¾æˆ¦ç›¸æ‰‹ã®Rã‚’Â±100ã®ç¯„å›²ã§ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®š
            cpuRating = INITIAL_RATING + Math.floor(Math.random() * 200) - 100; 
            
            // X IDã‚’è¨­å®š
            const isCPU = (mode === 'cpu');
            opponentXId = generateRandomXId(isCPU);
            const opponentType = isCPU ? 'CPU (ãƒ†ã‚¹ãƒˆç”¨)' : 'åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼';

            // è‡ªåˆ†ã¨ç›¸æ‰‹ã®æƒ…å ±ã‚’è¡¨ç¤º (Match Result Screen)
            document.getElementById('myInfoDisplay').innerHTML = 
                `ID: **${PLAYER_ID}**<br>R: ${Math.round(playerRating)}`;
            document.getElementById('opponentInfo').innerHTML = 
                `ID: **${opponentXId}**<br>R: ${Math.round(cpuRating)}`;

            selectedSongs = selectRandomSongs(3);
            
            const songListElement = document.getElementById('selectedSongs');
            songListElement.innerHTML = '';
            
            selectedSongs.forEach(song => {
                const li = document.createElement('li');
                li.textContent = song;
                songListElement.appendChild(li);
            });

            showScreen('matchResultScreen');
        }

        // çµæœç”³å‘Šç”»é¢ã¸é·ç§» (ä¿®æ­£ç‚¹: ç›¸æ‰‹IDè¡¨ç¤ºã‚’è¿½åŠ )
        function goToResultSubmission() {
            const submissionList = document.getElementById('submissionSongs');
            submissionList.innerHTML = '';
            
            selectedSongs.forEach(song => {
                const li = document.createElement('li');
                li.textContent = song;
                submissionList.appendChild(li);
            });
            
            // ç›¸æ‰‹ã®IDã‚’è¡¨ç¤º
            const opponentDisplay = document.getElementById('opponentDisplayInSubmission');
            if (opponentDisplay) {
                 opponentDisplay.textContent = `å¯¾æˆ¦ç›¸æ‰‹: ${opponentXId}`;
            }
            
            showScreen('resultSubmissionScreen');
        }

        // çµæœç”³å‘Šã¨ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—
        function submitResult(playerResultScore) {
            let resultAction = "";
            if (playerResultScore === 1) resultAction = "å‹åˆ©";
            else if (playerResultScore === 0) resultAction = "æ•—åŒ—";
            else resultAction = "å¼•ãåˆ†ã‘";

            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            if (!confirm(`å¯¾æˆ¦çµæœã‚’ã€Œ${resultAction}ã€ã§ç”³å‘Šã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n(å¯¾æˆ¦ç›¸æ‰‹ID: ${opponentXId})`)) {
                return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®å ´åˆã€å‡¦ç†ã‚’ä¸­æ–­
            }

            let resultText = "";
            let resultClass = "";

            if (playerResultScore === 1) {
                resultText = "ğŸ† å‹åˆ©ï¼ ğŸ†";
                resultClass = "win-text";
            } else if (playerResultScore === 0) {
                resultText = "æ•—åŒ—...";
                resultClass = "lose-text";
            } else {
                resultText = "å¼•ãåˆ†ã‘ï¼";
                resultClass = "draw-text";
            }
            
            calculateAndDisplayRating(playerResultScore, resultText, resultClass);
        }
        
        // ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—ã¨çµæœè¡¨ç¤º
        function calculateAndDisplayRating(pResult, rText, rClass) {
            
            const expectedPlayerScore = calculateExpectedScore(playerRating, cpuRating);
            const expectedCpuScore = calculateExpectedScore(cpuRating, playerRating); 

            const oldPlayerR = playerRating;
            const oldCpuR = cpuRating;
            
            const newPlayerR = updateRating(oldPlayerR, expectedPlayerScore, pResult, K_FACTOR);
            const newCpuR = updateRating(oldCpuR, expectedCpuScore, 1 - pResult, K_FACTOR);
            
            const deltaPlayerR = Math.round(newPlayerR - oldPlayerR);
            const deltaCpuR = Math.round(newCpuR - oldCpuR);
            
            playerRating = newPlayerR;
            cpuRating = newCpuR;
            
            // 3. çµæœç”»é¢ã«è¡¨ç¤º
            const resultHeading = document.getElementById('resultHeading');
            resultHeading.textContent = rText;
            resultHeading.className = rClass;

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã€ã¾ãšæ—§Rã¨äºˆæƒ³å€¤ã‚’è¡¨ç¤º
            document.getElementById('playerOldR').textContent = Math.round(oldPlayerR);
            document.getElementById('playerNewR').textContent = Math.round(oldPlayerR); // åˆæœŸã¯æ—§R
            document.getElementById('playerDeltaR').textContent = `è¨ˆç®—ä¸­...`; // åˆæœŸã¯è¨ˆç®—ä¸­
            document.getElementById('playerExpected').textContent = `${(expectedPlayerScore * 100).toFixed(1)}%`;
            document.getElementById('playerDeltaR').style.color = 'black'; // ãƒªã‚»ãƒƒãƒˆ

            document.getElementById('cpuOldR').textContent = Math.round(oldCpuR);
            document.getElementById('cpuNewR').textContent = Math.round(oldCpuR); // åˆæœŸã¯æ—§R
            document.getElementById('cpuDeltaR').textContent = `è¨ˆç®—ä¸­...`; // åˆæœŸã¯è¨ˆç®—ä¸­
            document.getElementById('cpuExpected').textContent = `${(expectedCpuScore * 100).toFixed(1)}%`;
            document.getElementById('cpuDeltaR').style.color = 'black'; // ãƒªã‚»ãƒƒãƒˆ

            showScreen('resultScreen');

            // --- ãƒ¬ãƒ¼ãƒˆå¤‰å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ---
            setTimeout(() => {
                document.getElementById('playerNewR').textContent = Math.round(newPlayerR);
                document.getElementById('playerDeltaR').textContent = `${deltaPlayerR > 0 ? '+' : ''}${deltaPlayerR}`;
                document.getElementById('playerDeltaR').style.color = deltaPlayerR > 0 ? 'blue' : (deltaPlayerR < 0 ? 'red' : 'black');
                
                document.getElementById('cpuNewR').textContent = Math.round(newCpuR);
                document.getElementById('cpuDeltaR').textContent = `${deltaCpuR > 0 ? '+' : ''}${deltaCpuR}`;
                document.getElementById('cpuDeltaR').style.color = deltaCpuR > 0 ? 'blue' : (deltaCpuR < 0 ? 'red' : 'black');

                // å¤‰å‹•ã‚’è¦–è¦šçš„ã«å¼·èª¿
                document.getElementById('playerDeltaR').style.fontSize = '1.3em';
                document.getElementById('cpuDeltaR').style.fontSize = '1.3em';
            }, 1000); // 1ç§’å¾Œã«ãƒ¬ãƒ¼ãƒˆå¤‰å‹•ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º

        }

        // åˆæœŸè¡¨ç¤º
        resetGame();

    </script>

</body>
</html>

